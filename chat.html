<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Classroom</title>
  <style>
    body { font-family: sans-serif; background: #eaeaea; }
    #chat-box { height: 400px; overflow-y: scroll; background: white; padding: 1em; margin-bottom: 1em; }
    #message { width: 80%; padding: 0.5em; }
    #send { padding: 0.5em 1em; }
  </style>
</head>
<body>
  <h2>チャットルーム</h2>
  <div id="chat-box"></div>
  <input type="text" id="message" placeholder="メッセージを入力">
  <button id="send">送信</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<script type="module">
  // Firebase SDKのモジュールをインポート
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyCt-kBplOktF-fXODzY61n2N2hb_Hkgm6A",
    authDomain: "chat-app-web-6d4fc.firebaseapp.com",
    projectId: "chat-app-web-6d4fc",
    storageBucket: "chat-app-web-6d4fc.firebasestorage.app",
    messagingSenderId: "226877931746",
    appId: "1:226877931746:web:a0497db65c18b5ddda5ebb",
    measurementId: "G-PMX006ZKWS"
  };

  // Firebaseの初期化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ユーザー名をセッションから取得
  const username = sessionStorage.getItem("username");

  // メッセージ送信
  document.getElementById("send").onclick = async () => {
    const messageInput = document.getElementById("message");
    const msg = messageInput.value;
    
    if (msg) {
      try {
        // Firestoreにメッセージを追加
        await addDoc(collection(db, "messages"), {
          user: username,
          message: msg,
          timestamp: new Date()
        });
        
        messageInput.value = ""; // メッセージ入力欄をクリア
      } catch (error) {
        console.error("Error adding document: ", error);
      }
    }
  };

  // Firestoreからメッセージをリアルタイムで取得して表示
  const messagesQuery = query(collection(db, "messages"), orderBy("timestamp"));
  onSnapshot(messagesQuery, snapshot => {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = ""; // 古いメッセージをクリア

    snapshot.forEach(doc => {
      const data = doc.data();
      chatBox.innerHTML += `<p><strong>${data.user}:</strong> ${data.message}</p>`;
    });

    // 常に一番下にスクロール
    chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>
</body>
</html>
